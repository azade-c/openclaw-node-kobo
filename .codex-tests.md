# Task: Set deviceFamily and create exhaustive documentation-quality tests

## Part 1: Set deviceFamily in DefaultRegistration

In `internal/gateway/node.go`, set `DeviceFamily: "kobo"` in the `ClientInfo` of `DefaultRegistration()`.

## Part 2: Exhaustive test suite

Create comprehensive tests that serve as living documentation for the entire gateway package. Tests should be organized with clear names that describe the behavior being tested. Use Go subtests (`t.Run`) for grouping related scenarios.

### Coverage requirements

Every public function, every exported type behavior, and every edge case must be tested. The tests are the documentation — someone reading them should understand the full protocol.

#### identity.go — `internal/gateway/identity_test.go`
Already has: roundtrip, sign/verify, payload format v1/v2, base64url, public key length, device ID derivation.

**Add:**
- `TestLoadOrCreateIdentity_CorruptedFile` — invalid JSON in device.json should error
- `TestLoadOrCreateIdentity_MissingKeys` — file exists but publicKeyPem/privateKeyPem empty
- `TestLoadOrCreateIdentity_FilePermissions` — created file has 0600 permissions
- `TestLoadOrCreateIdentity_DerivedDeviceID` — if stored deviceId is empty, it's recomputed from pubkey
- `TestDeviceIdentity_SignEmptyPayload` — signing empty string works
- `TestDeviceIdentity_SignConsistency` — same payload produces same signature (deterministic Ed25519)
- `TestDeviceIdentity_PublicKeyRawBase64Url_Deterministic` — multiple calls return same value
- `TestBuildDeviceAuthPayload_EmptyScopes` — nil and empty slice produce same result
- `TestBuildDeviceAuthPayload_EmptyToken` — token="" is included as empty field in payload
- `TestBuildDeviceAuthPayload_SpecialCharacters` — pipes in values are NOT escaped (documenting behavior)
- `TestBuildDeviceAuthPayload_V1VsV2` — explicit documentation of when v1 vs v2 is used

#### device_token.go — `internal/gateway/device_token_test.go` (NEW FILE)
- `TestSaveAndLoadDeviceToken` — roundtrip
- `TestLoadDeviceToken_NotExists` — returns empty string, no error
- `TestLoadDeviceToken_CorruptedJSON` — returns error
- `TestSaveDeviceToken_Permissions` — file created with 0600
- `TestSaveDeviceToken_Overwrites` — saving twice overwrites first value
- `TestClearDeviceToken_Exists` — removes file
- `TestClearDeviceToken_NotExists` — no error
- `TestClearDeviceToken_EmptyPath` — no error, no-op
- `TestDeviceTokenRoundtrip_WithTimestamp` — savedAtMs is populated

#### protocol.go — `internal/gateway/protocol_test.go`
Already has: DefaultRegistration, DeviceInfoJSON.

**Add:**
- `TestConnectParams_JSONRoundtrip` — full ConnectParams with all fields serialize/deserialize correctly
- `TestConnectParams_OmitsEmptyFields` — nil/empty optional fields are omitted from JSON
- `TestHelloOkPayload_WithAuth` — parse hello-ok with device token
- `TestHelloOkPayload_WithoutAuth` — parse hello-ok without auth field
- `TestEventFrame_JSONRoundtrip` — EventFrame with payload
- `TestRequestFrame_JSONRoundtrip` — RequestFrame with method and params
- `TestResponseFrame_WithError` — ResponseFrame with error field
- `TestResponseFrame_WithPayload` — ResponseFrame with ok=true and payload
- `TestInvokeRequestParams_ParamsJSON` — both paramsJSON and params field handling
- `TestNodeEventParams_JSON` — NodeEventParams serialization
- `TestDefaultRegistration_DeviceFamily` — verify deviceFamily is "kobo"
- `TestDefaultRegistration_AllFields` — exhaustive check of every field in default registration
- `TestDefaultRegistration_Commands` — all expected canvas commands are present
- `TestDefaultRegistration_ClientID` — client ID is "node-host" (required by gateway)

#### client.go — `internal/gateway/client_test.go`
Already has: write mutex, connect handshake, connect auth, connect challenge, ping ticker, device token mismatch.

**Add:**
- `TestClient_New_DefaultPingInterval` — default ping interval is 30s
- `TestClient_New_CustomPingInterval` — custom ping interval is respected
- `TestClient_New_LoadsDeviceToken` — device token loaded from file at creation
- `TestClient_New_NoIdentity` — client without identity sends no device block
- `TestClient_ConnectHandshake_RejectsNonHelloOk` — server responds with unexpected payload type
- `TestClient_ConnectHandshake_ServerRejects` — server responds ok=false
- `TestClient_ConnectHandshake_ServerRejectsWithError` — ok=false with error message
- `TestClient_ConnectHandshake_DeviceTokenStored` — hello-ok with deviceToken is persisted
- `TestClient_ConnectHandshake_DeviceTokenPreferred` — on reconnect, device token used instead of shared secret
- `TestClient_ConnectChallenge_IgnoresSameNonce` — challenge with same nonce as current is ignored
- `TestClient_ConnectChallenge_IgnoresEmptyNonce` — challenge with empty nonce is ignored
- `TestClient_ReadLoop_InvokeEvent` — node.invoke.request triggers handler
- `TestClient_ReadLoop_InvokeRequest` — req-type invoke triggers handler
- `TestClient_ReadLoop_UnknownEventIgnored` — unknown event type doesn't crash
- `TestClient_ReadLoop_VoicewakeIgnored` — voicewake.changed is silently ignored
- `TestClient_SendEvent_NoConnection` — returns error when not connected
- `TestClient_SendEvent_MarshalsCorrectly` — event frame has correct type/method/params
- `TestClient_SelectConnectAuth_DeviceTokenOverSharedSecret` — device token wins
- `TestClient_SelectConnectAuth_FallbackToSharedSecret` — no device token → shared secret
- `TestClient_SelectConnectAuth_PasswordPreserved` — password kept alongside device token
- `TestClient_SelectConnectAuth_NoAuth` — no token, no password → nil auth
- `TestClient_BuildConnectRequest_WithNonce` — nonce included in device info
- `TestClient_BuildConnectRequest_WithoutNonce` — no nonce → v1 payload
- `TestClient_BuildConnectRequest_NoIdentity` — no identity → no device block
- `TestClient_BuildConnectRequest_AllFields` — all registration fields propagated to ConnectParams
- `TestClient_HandleCloseError_NonWebsocket` — non-websocket error is ignored
- `TestClient_HandleCloseError_WrongCode` — code != 1008 is ignored
- `TestClient_HandleCloseError_WrongReason` — code 1008 but different reason is ignored
- `TestClient_BackoffGrowth` — backoff doubles each failure, caps at some max
- `TestClient_InvokeResult_Success` — invoke result sent back correctly
- `TestClient_InvokeResult_Error` — invoke error sent back correctly
- `TestParseInvokePayload_ParamsJSON` — paramsJSON string field parsed
- `TestParseInvokePayload_Params` — params object field parsed
- `TestParseInvokePayload_BothFields` — paramsJSON preferred over params
- `TestParseInvokePayload_MissingRequestID` — error on missing id

#### node.go — tests in `internal/gateway/protocol_test.go`
- `TestDefaultRegistration_DeviceFamily_Kobo` — deviceFamily == "kobo"
- `TestDefaultRegistration_InstanceID_Empty` — instanceId not set by default (set at runtime)

## Constraints
- Go stdlib only
- All tests pass with `GOCACHE=/tmp/go-build go test ./... -race -count=1`
- Use `t.Run()` for subtests where it groups related scenarios
- Test names should be self-documenting (reading the test list = reading the spec)
- Do NOT modify any files in `/root/openclaw/`
