# Review Task: Device auth implementation vs gateway protocol

Review the device identity and authentication implementation in this Go project against the official OpenClaw gateway source at `/root/openclaw`.

## What was implemented
- Ed25519 device identity (generate/load keypair, device.json persistence)
- Device auth payload signing (v2 format)
- Device block in connect handshake
- hello-ok device token parsing and persistence (device-token.json)
- Device token preferred over shared secret on reconnect

## Known gaps to verify and fix

### 1. connect.challenge nonce handling
The gateway can send a `connect.challenge` event with a `nonce` BEFORE the connect handshake completes. See `/root/openclaw/src/gateway/client.ts` lines 295-310:
```typescript
if (evt.event === "connect.challenge") {
  const nonce = payload?.nonce;
  if (nonce) {
    this.connectNonce = nonce;
    this.sendConnect();  // re-send connect with nonce in signature
  }
}
```
The Kobo node must handle this: if a `connect.challenge` event arrives during the handshake, extract the nonce, re-sign the device auth payload including the nonce, and re-send the connect request.

Reference: The nonce goes into `BuildDeviceAuthPayload(..., nonce)` and `DeviceInfo.Nonce`.

### 2. Device token mismatch recovery
When the gateway closes with code 1008 and reason containing "device token mismatch", the official client clears the stored device token so the next reconnect falls back to shared secret auth. See `/root/openclaw/src/gateway/client.ts` lines 157-165.

The Kobo node should detect this close reason and clear `deviceToken` (both in memory and delete/clear device-token.json).

### 3. General protocol compliance check
Cross-reference ALL fields in the connect params against:
- `/root/openclaw/src/gateway/protocol/schema/frames.ts` — ConnectParamsSchema
- `/root/openclaw/src/gateway/client.ts` — sendConnect() method
- `/root/openclaw/src/gateway/server/ws-connection/message-handler.ts` — connect handler

Check for any missing fields we should be sending (e.g. `permissions`, `pathEnv`, `scopes` in connect params).

### 4. Review the readLoop for event handling
Currently `readLoop` in `client.go` only handles `req` type frames (for invokes). Check if it should also handle `event` type frames for:
- `connect.challenge` (nonce)
- `voicewake.changed` (can ignore for Kobo, but should not crash)
- Any other gateway-sent events

### 5. Verify device auth payload format
Compare `BuildDeviceAuthPayload` output with `/root/openclaw/src/gateway/device-auth.ts` `buildDeviceAuthPayload`. Ensure field order and separator are identical.

## Files to review
- `internal/gateway/identity.go` — crypto implementation
- `internal/gateway/device_token.go` — token persistence
- `internal/gateway/client.go` — handshake, reconnect, readLoop
- `internal/gateway/protocol.go` — frame types
- `cmd/openclaw-node-kobo/main.go` — wiring

## Reference files in gateway source
- `/root/openclaw/src/gateway/client.ts` — official client implementation
- `/root/openclaw/src/gateway/device-auth.ts` — payload format
- `/root/openclaw/src/infra/device-identity.ts` — identity generation
- `/root/openclaw/src/infra/device-auth-store.ts` — token storage
- `/root/openclaw/src/gateway/server/ws-connection/message-handler.ts` — server-side handler
- `/root/openclaw/src/gateway/protocol/schema/frames.ts` — frame schemas

## Constraints
- Fix all issues found — implement missing features
- Go stdlib only for crypto
- All tests must pass with `GOCACHE=/tmp/go-build go test ./... -race -count=1`
- Do NOT modify any files in `/root/openclaw/` — read-only reference
