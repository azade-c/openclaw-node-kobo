# Task: Implement Ed25519 device identity and authentication

## Context
The openclaw-node-kobo project connects to an OpenClaw gateway as a `node` role client. Currently it only sends `auth.token`/`auth.password` (shared secret) in the `connect` handshake. The official OpenClaw gateway client also sends a `device` block with Ed25519 crypto identity, which enables device pairing (approve/reject flow) and per-device auth tokens.

We need to implement the same device identity mechanism so the Kobo is a proper paired node.

## Reference: How the official client does it

### Device Identity (from gateway source)
- Generate Ed25519 keypair at first launch
- `deviceId` = `hex(sha256(publicKeyRaw))` where publicKeyRaw is the 32-byte Ed25519 public key (strip SPKI prefix)
- Store in `device.json`: `{ "version": 1, "deviceId": "...", "publicKeyPem": "...", "privateKeyPem": "...", "createdAtMs": ... }`
- Load on subsequent launches

### Device Auth Payload (signed string)
Format `v2` (pipe-separated):
```
v2|{deviceId}|{clientId}|{clientMode}|{role}|{scopes joined by comma}|{signedAtMs}|{token or empty}|{nonce or empty}
```

The signature is Ed25519 over this payload string (UTF-8 bytes), encoded as base64url (no padding).

### Connect params device block
```json
{
  "device": {
    "id": "{deviceId}",
    "publicKey": "{base64url of 32-byte raw public key}",
    "signature": "{base64url of Ed25519 signature}",
    "signedAt": {signedAtMs as integer},
    "nonce": "{nonce string or omitted}"
  }
}
```

### Hello-OK response may contain a device token
```json
{
  "type": "hello-ok",
  "auth": {
    "deviceToken": "...",
    "role": "node",
    "scopes": [...],
    "issuedAtMs": ...
  }
}
```
When received, store this `deviceToken` and use it as `auth.token` on subsequent connections (preferred over shared secret).

### Base64url encoding
Standard base64 with `+` → `-`, `/` → `_`, trailing `=` stripped.

## What to implement

### 1. New file: `internal/gateway/identity.go`
- `type DeviceIdentity struct` with `DeviceID`, `PublicKeyPem`, `PrivateKeyPem`
- `LoadOrCreateIdentity(path string) (*DeviceIdentity, error)` — load from JSON or generate new Ed25519 keypair
- `(d *DeviceIdentity) PublicKeyRawBase64Url() string` — 32-byte raw public key as base64url
- `(d *DeviceIdentity) Sign(payload string) string` — Ed25519 sign, return base64url
- `BuildDeviceAuthPayload(...)` — build the v2 pipe-separated payload string
- Use Go stdlib only: `crypto/ed25519`, `crypto/sha256`, `crypto/x509`, `encoding/pem`, `encoding/base64`

### 2. Update `internal/gateway/protocol.go`
- Add `DeviceInfo` struct: `ID`, `PublicKey`, `Signature`, `SignedAt`, `Nonce`
- Add `DeviceInfo *DeviceInfo` field to `ConnectParams`
- Update `HelloOkPayload` (or create it) to parse the `auth.deviceToken` from hello-ok response

### 3. Update `internal/gateway/client.go`
- Add `identity *DeviceIdentity` field to `Client`
- Add `deviceToken string` field (persisted across reconnects in memory)
- In `ClientConfig`, add `Identity *DeviceIdentity` and `DeviceTokenPath string`
- In `registerNode()`:
  - Build the device auth payload and sign it
  - Include `device` block in connect params
  - If `deviceToken` is set, use it as `auth.token` (preferred over shared secret)
  - Parse `hello-ok` response for `auth.deviceToken` and store it
- Add `LoadDeviceToken(path string)` / `SaveDeviceToken(path string, token string)` for persistence

### 4. Update `cmd/openclaw-node-kobo/main.go`
- Add logic to load/create device identity from `filepath.Dir(cfgPath) + "/device.json"`
- Pass identity to gateway client
- Device token path: `filepath.Dir(cfgPath) + "/device-token.json"`

### 5. Tests: `internal/gateway/identity_test.go`
- Test generate + load roundtrip
- Test sign + verify (use `crypto/ed25519` to verify in test)
- Test payload format matches expected v2 format
- Test base64url encoding (no padding, correct character substitution)
- Test PublicKeyRawBase64Url produces 32 bytes when decoded
- Test deviceId derivation matches `hex(sha256(rawPubKey))`

### 6. Update existing tests
- `internal/gateway/client_test.go` — update mock to handle device block in connect params
- `internal/gateway/protocol_test.go` — test DeviceInfo serialization

## Constraints
- Go stdlib only for crypto (no external dependencies)
- All tests must pass with `-race -count=1`
- Use `GOCACHE=/tmp/go-build` for running tests
- The `clientId` sent in the connect is `node-host` (already set)
- The `role` is `node`
- The `mode` from client is whatever is in `ConnectParams.Client.Mode` (should be `node`)
- Scopes: empty `[]` for nodes

## Build & test commands
```bash
cd /root/azade/code/openclaw-node-kobo
go build ./...
GOCACHE=/tmp/go-build go test ./... -race -count=1
```
